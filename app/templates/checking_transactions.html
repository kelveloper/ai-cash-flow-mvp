<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checking Transactions - Capital Two</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/tailwind.min.css') }}">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow p-4 flex items-center justify-center">
        <h1 class="text-7xl font-extrabold text-blue-900 tracking-tight">Capital Two</h1>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div id="app">
            <div class="main-content">
                <!-- Header -->
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <h1 class="text-2xl font-bold text-blue-900">Checking Account Transactions</h1>
                    </div>
                    <div class="flex gap-2">
                        <a href="/" class="btn bg-white text-blue-700 border border-blue-700 px-4 py-2 rounded shadow hover:bg-blue-50 font-semibold transition" title="Back to Dashboard">Home</a>
                        <button id="export-btn" class="btn btn-primary bg-blue-700 text-white px-4 py-2 rounded shadow hover:bg-blue-800 transition">Export Data</button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="bg-white rounded-xl shadow p-4 mb-6">
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <input type="text" id="search" placeholder="Search transactions..." 
                                   class="w-full px-3 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div class="w-[180px]">
                            <input type="date" id="date-range" 
                                   class="w-full px-3 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div class="w-[240px]">
                            <select id="category" 
                                    class="w-full px-3 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Month Navigation -->
                <div class="flex items-center justify-between mb-4">
                    <div class="w-[120px]">
                    <button id="prevMonth" class="text-blue-700 hover:underline text-sm font-semibold">Previous Month</button>
                    </div>
                    <div id="currentMonthLabel" class="text-lg font-bold text-blue-900 flex-1 text-center"></div>
                    <div id="nextMonthContainer" class="w-[120px] text-right">
                    <button id="nextMonth" class="text-blue-700 hover:underline text-sm font-semibold">Next Month</button>
                    </div>
                </div>

                <!-- Statement Ending Label -->
                <div class="flex items-center justify-between mb-4">
                    <div id="statementLabel" class="text-lg font-bold text-blue-900"></div>
                </div>

                <!-- Pending Transactions Section -->
                <div class="bg-white rounded-xl shadow p-4 mb-4">
                    <div class="flex items-center mb-2">
                        <h2 class="text-md font-semibold text-gray-800 mr-2">Pending Transactions</h2>
                        <span title="Transactions that are not yet posted." class="text-gray-400 cursor-help">&#9432;</span>
                    </div>
                    <div id="pendingTransactionsTable" style="max-height: 350px; overflow-y: auto;">
                        <!-- Pending transactions will be loaded here -->
                    </div>
                </div>

                <!-- Posted Transactions Section -->
                <div class="bg-white rounded-xl shadow p-4 mb-4">
                    <div class="flex items-center mb-2">
                        <h2 class="text-md font-semibold text-gray-800">Posted Transactions</h2>
                    </div>
                    <div id="postedTransactionsTable" style="max-height: 500px; overflow-y: auto;">
                        <!-- Posted transactions will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Dex Floating AI Button and Chatbot (now inside #app) -->
            <div id="dex-chatbot" style="position:fixed;bottom:32px;right:32px;z-index:9999;">
                <button v-if="!dexChatOpen" @click="dexChatOpen = true" style="width:64px;height:64px;border-radius:50%;background:#2563eb;color:white;font-size:2rem;box-shadow:0 4px 16px rgba(0,0,0,0.15);border:none;outline:none;cursor:pointer;display:flex;align-items:center;justify-content:center;">
                    ðŸ¤–
                </button>
                <div v-if="dexChatOpen" style="width:400px;min-height:300px;background:white;border-radius:1rem;box-shadow:0 4px 32px rgba(0,0,0,0.18);display:flex;flex-direction:column;">
                    <div style="background:#2563eb;color:white;padding:12px 20px;border-radius:1rem 1rem 0 0;display:flex;align-items:center;justify-content:space-between;">
                        <span style="font-weight:bold;">Dex - AI Assistant</span>
                        <button @click="dexChatOpen = false" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;">&minus;</button>
                    </div>
                    <div style="flex:1;overflow-y:auto;padding:16px;">
                        <div style="padding:12px 0 0 0;">
                            <div style="font-size:1.1em;font-weight:600;margin-bottom:12px;">
                                <span style="display:inline-block;background:#e0f2fe;color:#2563eb;padding:6px 16px;border-radius:16px;">
                                    You are currently viewing: <b>[[ getMonthLabel(getCurrentMonth()) ]]</b>
                                </span>
                            </div>
                        </div>
                        <div v-if="dexMonthChanged && !dexCategorized && !isDexLoading" style="color:#2563eb;font-weight:500;margin-bottom:10px;">
                            You are now viewing: <b>[[ getMonthLabel(getCurrentMonth()) ]]</b>. Would you like to categorize this month?
                        </div>
                        <div v-if="!dexCategorized && !isDexLoading" style="color:#374151;margin-bottom:12px;">
                            <b>Hi, I'm Dex!</b> I can categorize your transactions for the displayed month and generate a PDF report. Ready to get started?
                        </div>
                        <button v-if="!dexCategorized && !isDexLoading" @click="categorizeMonth" :disabled="isDexLoading" style="width:100%;background:#2563eb;color:white;padding:10px 0;border-radius:6px;margin-bottom:10px;font-weight:500;">Categorize This Month</button>
                        <div v-if="isDexLoading" style="color:#2563eb;font-weight:500;">Categorizing transactions...</div>
                        <div v-if="dexCategorized && !isDexLoading">
                            <div style="color:#059669;font-weight:600;margin-bottom:8px;font-size:0.98em;">
                                I noticed that for [[ getMonthLabel(getCurrentMonth()) ]], [[ dexResults.length ]] transactions were categorized.<br>
                                <span v-if="dexResults.length > 0">
                                    For example, '<span :title="dexResults[0]?.description">[[ dexResults[0]?.description?.slice(0, 24) ]]</span>' was categorized as '<span :title="dexResults[0]?.predicted">[[ dexResults[0]?.predicted ]]</span>' (was: '<span :title="dexResults[0]?.original_category">[[ dexResults[0]?.original_category ]]</span>')<span v-if="dexResults[0]?.explanation"> because: <span :title="dexResults[0]?.explanation">[[ dexResults[0]?.explanation?.slice(0, 32) ]]</span></span>.
                                </span>
                            </div>
                            <div style="max-height:140px;overflow-y:auto;margin-bottom:8px;">
                                <table style="width:100%;font-size:0.92em;">
                                    <thead>
                                        <tr style="background:#f3f4f6;">
                                            <th style="padding:2px 4px;">Description</th>
                                            <th style="padding:2px 4px;">Original</th>
                                            <th style="padding:2px 4px;">AI Suggestion</th>
                                            <th style="padding:2px 4px;">Why?</th>
                                            <th style="padding:2px 4px;">Change</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(tx, idx) in dexResults" :key="idx">
                                            <td style="padding:2px 4px;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" :title="tx.description">[[ tx.description?.slice(0, 18) ]]</td>
                                            <td style="padding:2px 4px;max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" :title="tx.original_category">[[ tx.original_category ]]</td>
                                            <td style="padding:2px 4px;max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" :title="tx.predicted">[[ tx.predicted ]]</td>
                                            <td style="padding:2px 4px;max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" :title="tx.explanation || 'No explanation available'">
                                                <span v-if="tx.explanation">[[ tx.explanation.slice(0, 28) ]]</span>
                                                <span v-else>No explanation available</span>
                                            </td>
                                            <td style="padding:2px 4px;">
                                                <select v-model="tx.user_category" style="border:1px solid #ddd;border-radius:4px;padding:2px 4px;font-size:0.92em;">
                                                    <option v-for="cat in allCategories" :key="cat" :value="cat">[[ cat ]]</option>
                                                </select>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-bottom:8px;font-size:0.97em;">Are these categorizations correct?</div>
                            <div style="display:flex;gap:8px;margin-bottom:8px;">
                                <button @click="confirmChanges" style="flex:1;background:#059669;color:white;padding:8px 0;border-radius:6px;font-weight:500;font-size:0.97em;">Yes, Save Changes</button>
                                <button @click="cancelChanges" style="flex:1;background:#dc2626;color:white;padding:8px 0;border-radius:6px;font-weight:500;font-size:0.97em;">No, Cancel</button>
                            </div>
                            <button @click="generatePDFWithUserCategories" :disabled="isPDFLoading" style="width:100%;background:#2563eb;color:white;padding:8px 0;border-radius:6px;font-weight:500;font-size:0.97em;">Download PDF (with reviewed categories)</button>
                        </div>
                        <div v-if="isPDFLoading" style="color:#059669;font-weight:500;margin-top:10px;">Generating PDF...</div>
                        <div v-if="dexError" style="color:#dc2626;margin-top:8px;">[[ dexError ]]</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Debug script to verify script loading -->
    <script>
        console.log('Debug: transactions.html loaded');
        window.addEventListener('load', () => {
            console.log('Debug: Window load event fired');
            const loadPrevBtn = document.getElementById('loadPrevious');
            console.log('Debug: loadPrevious button found:', loadPrevBtn);
        });
    </script>
    <script src="{{ url_for('static', path='js/transactions.js') }}?v=1.0.1" defer></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp } = Vue

        // Initialize currentMonth with current date
        window.currentMonth = new Date().toISOString().slice(0, 7); // Format: YYYY-MM
        console.log('[DEBUG] Initialized currentMonth:', window.currentMonth);

        createApp({
            delimiters: ['[[', ']]'],
            data() {
                return {
                    // Dex Chatbot
                    dexChatOpen: false,
                    dexCategorized: false,
                    dexResults: null,
                    dexError: null,
                    isDexLoading: false,
                    isPDFLoading: false,
                    allCategories: [
                        'utilities',
                        'rent',
                        'groceries',
                        'transportation',
                        'entertainment',
                        'healthcare',
                        'subscriptions',
                        'fees',
                        'taxes',
                        'insurance',
                        'supplies',
                        'merchandise',
                        'food',
                        'coffee',
                        'marketing',
                        'maintenance',
                        'pastry',
                        'sandwich',
                        'catering',
                        'misc',
                        'other'
                    ],
                    userInput: '',
                    dexMonthChanged: false,
                    dexNoChangesMade: false,
                    dexChangesMade: false,
                    dexUserCategories: {},
                    dexSuccessMessage: '',
                    dexErrorMessage: '',
                    showDownloadButton: false,
                    currentMonth: new Date()
                }
            },
            mounted() {
                // Listen for month changes
                window.addEventListener('dex-month-changed', this.handleMonthChange);
                this.fetchCategories();
                
                // Initialize currentMonth if not set
                if (!window.currentMonth) {
                    window.currentMonth = new Date().toISOString().slice(0, 7);
                    console.log('[DEBUG] Set initial currentMonth:', window.currentMonth);
                }
            },
            beforeUnmount() {
                window.removeEventListener('dex-month-changed', this.handleMonthChange);
            },
            methods: {
                getCurrentMonth() {
                    return window.currentMonth;
                },
                async fetchCategories() {
                    try {
                        const response = await fetch('/api/categories');
                        if (!response.ok) throw new Error('Failed to fetch categories');
                        this.allCategories = await response.json();
                    } catch (err) {
                        console.error('Error fetching categories:', err);
                    }
                },
                async categorizeMonth() {
                    try {
                        console.log('[DEBUG] Starting categorization');
                        const currentMonth = this.formatMonth(new Date());
                        console.log('[DEBUG] Current month:', currentMonth);
                        
                        const response = await fetch('/api/categorize-month', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ month: currentMonth })
                        });
                        
                        console.log('[DEBUG] Response status:', response.status);
                        
                        if (!response.ok) {
                            throw new Error('Failed to categorize: ' + response.statusText);
                        }
                        
                        const results = await response.json();
                        console.log('[DEBUG] Received results:', results);
                        
                        // Initialize user categories for all transactions
                        this.dexResults = results.map(tx => ({
                            ...tx,
                            user_category: tx.original_category || tx.predicted || 'misc'
                        }));
                        
                        console.log('[DEBUG] Initialized categories for', this.dexResults.length, 'transactions');
                        console.log('[DEBUG] Filtered results for current month:', this.dexResults);
                        
                        // Show the chat interface
                        this.showDexChat = true;
                        
                    } catch (error) {
                        console.error('[DEBUG] Error in categorization:', error);
                        this.dexErrorMessage = error.message;
                    }
                },
                handleMonthChange() {
                    // Reset Dex state
                    this.dexCategorized = false;
                    this.dexResults = null;
                    this.dexError = null;
                    this.dexMonthChanged = true;
                    
                    // Refresh categories for the new month
                    this.fetchCategories();
                    
                    // If Dex is open, automatically categorize the new month
                    if (this.dexChatOpen) {
                        this.categorizeMonth();
                    }
                },
                async confirmChanges() {
                    if (!this.dexChangesMade) {
                        this.dexNoChangesMade = true;
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/update-transaction-categories', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                categories: this.dexUserCategories
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to save changes');
                        }
                        
                        // Reset state
                        this.dexChangesMade = false;
                        this.dexUserCategories = {};
                        this.dexNoChangesMade = false;
                        
                        // Refresh transactions table
                        await this.loadTransactions();
                        
                        // Show success message
                        this.dexSuccessMessage = 'Changes saved successfully!';
                        setTimeout(() => {
                            this.dexSuccessMessage = '';
                        }, 3000);
                        
                        // Ask user if they want to download PDF
                        if (confirm('Would you like to download the updated transaction report?')) {
                            console.log('[DEBUG] User confirmed PDF download');
                            try {
                                await this.generatePDFWithUserCategories();
                                console.log('[DEBUG] PDF generation completed successfully');
                                this.dexSuccessMessage = 'PDF generated successfully!';
                            } catch (error) {
                                console.error('[DEBUG] Error generating PDF:', error);
                                this.dexErrorMessage = 'Failed to generate PDF. Please try again.';
                            }
                        } else {
                            console.log('[DEBUG] User declined PDF download');
                        }
                    } catch (error) {
                        console.error('[DEBUG] Error saving changes:', error);
                        this.dexErrorMessage = 'Failed to save changes. Please try again.';
                        setTimeout(() => {
                            this.dexErrorMessage = '';
                        }, 3000);
                    }
                },
                cancelChanges() {
                    this.dexError = "No changes were made to any categories.";
                    this.dexNoChangesMade = true;
                    setTimeout(() => {
                        this.dexChatOpen = false;
                        this.dexCategorized = false;
                        this.dexResults = null;
                        this.dexError = null;
                    }, 2000);
                },
                formatMonth(date) {
                    if (!(date instanceof Date) || isNaN(date)) {
                        console.error('[DEBUG] Invalid date:', date);
                        return null;
                    }
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    return `${year}-${month}`;
                },
                async generatePDFWithUserCategories() {
                    console.log('[DEBUG] Starting PDF generation...');
                    try {
                        const response = await fetch('/api/generate-month-pdf', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/pdf'
                            },
                            body: JSON.stringify({
                                month: this.formatMonth(this.currentMonth),
                                transactions: this.dexResults ? this.dexResults.map(tx => ({
                                    id: tx.id,
                                    description: tx.description,
                                    category: tx.user_category || tx.predicted,
                                    amount: tx.amount,
                                    date: tx.date
                                })) : [],
                                no_changes: this.dexNoChangesMade
                            })
                        });
                        
                        console.log('[DEBUG] PDF generation response status:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`Failed to generate PDF: ${response.statusText}`);
                        }
                        
                        // Get the blob from the response
                        const blob = await response.blob();
                        console.log('[DEBUG] PDF blob received:', blob.size, 'bytes');
                        
                        // Create a URL for the blob
                        const url = window.URL.createObjectURL(blob);
                        console.log('[DEBUG] Created blob URL:', url);
                        
                        // Create a temporary link element
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `transactions_${this.formatMonth(this.currentMonth)}.pdf`;
                        console.log('[DEBUG] Setting download filename:', link.download);
                        
                        // Append to body, click, and remove
                        document.body.appendChild(link);
                        console.log('[DEBUG] Triggering download...');
                        link.click();
                        document.body.removeChild(link);
                        
                        // Clean up the blob URL
                        window.URL.revokeObjectURL(url);
                        console.log('[DEBUG] PDF download completed');
                        
                        return true;
                    } catch (error) {
                        console.error('[DEBUG] Error in PDF generation:', error);
                        throw error;
                    }
                },
                closeDexChat() {
                    this.dexChatOpen = false;
                    this.dexCategorized = false;
                    this.dexResults = null;
                    this.dexError = null;
                    this.dexSuccessMessage = '';
                    this.dexErrorMessage = '';
                    this.dexNoChangesMade = false;
                    this.showDownloadButton = false;
                }
            },
            computed: {
                getMonthLabel() {
                    return function(monthYear) {
                        if (!monthYear) return '';
                        const [year, month] = monthYear.split('-');
                        const d = new Date(year, parseInt(month) - 1, 1);
                        return `${d.toLocaleString('en-US', { month: 'long' })} ${d.getFullYear()}`;
                    }
                }
            }
        }).mount('#app')

        // Patch month navigation to dispatch Dex event
        const origPrev = window.prevMonthBtn && prevMonthBtn.onclick;
        const origNext = window.nextMonthBtn && nextMonthBtn.onclick;
        if (window.prevMonthBtn) {
            prevMonthBtn.addEventListener('click', () => {
                setTimeout(() => window.dispatchEvent(new Event('dex-month-changed')), 100);
            });
        }
        if (window.nextMonthBtn) {
            nextMonthBtn.addEventListener('click', () => {
                setTimeout(() => window.dispatchEvent(new Event('dex-month-changed')), 100);
            });
        }
    </script>
</body>
</html> 